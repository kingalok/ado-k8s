parameters:
  imageRef: ""
  keyRef: ""

steps:
- powershell: |
    $ErrorActionPreference = 'Continue'
    $cosignVersion = "v2.2.3"
    $url = "https://github.com/sigstore/cosign/releases/download/$cosignVersion/cosign-windows-amd64.exe"
    Invoke-WebRequest $url -OutFile cosign.exe
    if ("${{ parameters.keyRef }}" -eq "keyless") {
      .\cosign.exe sign ${{ parameters.imageRef }} || echo "cosign sign (keyless) non-blocking failure."
    } elseif ("${{ parameters.keyRef }}" -eq "" ) {
      Write-Host "Cosign key not configured; skipping signing."
    } else {
      .\cosign.exe sign --key "${{ parameters.keyRef }}" ${{ parameters.imageRef }} || echo "cosign sign non-blocking failure."
    }
  displayName: "Cosign sign image (best-effort)"
  continueOnError: true
